{"version":3,"sources":["../src/annotations.ts"],"names":["d3","$","_","TOOLTIP_PADDING_X","TOOLTIP_PADDING_Y","AnnotationTooltip","elem","scope","dashboard","ctrl","panelCtrl","panel","mouseOverAnnotationTick","on","onMouseOver","bind","onMouseLeave","e","tooltip","show","data","isEmpty","add","move","destroy","tooltipBase","select","append","attr","style","remove","pos","annoId","target","anno","annotations","annoTitle","tooltipTimeFormat","annoTime","formatDate","time","annoText","text","annoTags","tags","map","t","tooltipHtml","join","backColor","borderColor","html","node","tooltipWidth","clientWidth","tooltipHeight","clientHeight","left","pageX","top","pageY","window","innerWidth","pageYOffset","innerHeight"],"mappings":"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","sourcesContent":["import d3 from 'd3';\nimport $ from 'jquery';\nimport _ from 'lodash';\n\nlet TOOLTIP_PADDING_X = 30;\nlet TOOLTIP_PADDING_Y = 10;\n\nexport class AnnotationTooltip {\n  scope: any;\n  dashboard: any;\n  panelCtrl: any;\n  panel: any;\n  mouseOverAnnotationTick: boolean;\n\n  tooltipBase: any;\n  tooltip: any;\n\n  constructor(elem, scope) {\n    this.scope = scope;\n    this.dashboard = scope.ctrl.dashboard;\n    this.panelCtrl = scope.ctrl;\n    this.panel = scope.ctrl.panel;\n    this.mouseOverAnnotationTick = false;\n\n    elem.on(\"mouseover\", this.onMouseOver.bind(this));\n    elem.on(\"mouseleave\", this.onMouseLeave.bind(this));\n  }\n\n  onMouseOver(e) {\n    if (!this.panel.tooltip.show || !this.scope.ctrl.data || _.isEmpty(this.scope.ctrl.data)) { return; }\n\n    if (!this.tooltip) {\n      this.add();\n      this.move(e);\n    }\n  }\n\n  onMouseLeave() {\n    this.destroy();\n  }\n\n  onMouseMove(e) {\n    if (!this.panel.tooltip.show) { return; }\n\n    this.move(e);\n  }\n\n  add() {\n    this.tooltipBase = d3.select(\"body\")\n    .append(\"div\")\n    .attr(\"class\", \"statusmap-annotation-tooltip drop drop-popover drop-popover--annotation drop-element drop-enabled drop-target-attached-center drop-open drop-open-transitionend drop-after-open\")\n    .style(\"position\", \"absolute\")\n    this.tooltip = this.tooltipBase\n      .append(\"div\")\n      .attr(\"class\", \"drop-content\")\n      .append(\"div\")\n      .append(\"annotation-tooltip\")\n      .append(\"div\")\n      .attr(\"class\", \"graph-annotation\");\n  }\n\n  destroy() {\n    if (this.tooltip) {\n      this.tooltip.remove();\n    }\n\n    this.tooltip = null;\n\n    if (this.tooltipBase) {\n      this.tooltipBase.remove();\n    }\n\n    this.tooltipBase = null;\n\n  }\n\n  show(pos) {\n    if (!this.panel.tooltip.show || !this.tooltip) { return; }\n    // shared tooltip mode\n    //if (pos.panelRelY) {\n    //  return;\n    //}\n\n    let annoId = d3.select(pos.target).attr('annoId');\n    if (!annoId) {\n      this.destroy();\n      return;\n    }\n\n    let anno = this.panelCtrl.annotations[annoId];\n    if (!anno) {\n      this.destroy();\n      return;\n    }\n\n    let annoTitle = \"\";\n\n    let tooltipTimeFormat = 'YYYY-MM-DD HH:mm:ss';\n    let annoTime = this.dashboard.formatDate(anno.time, tooltipTimeFormat);\n    let annoText = anno.text;\n    let annoTags:any = [];\n    if (anno.tags) {\n      annoTags = _.map(anno.tags, t => ({\"text\": t, \"backColor\": \"rgb(63, 43, 91)\", \"borderColor\":\"rgb(101, 81, 129)\"}))\n    }\n\n    let tooltipHtml = `<div class=\"graph-annotation__header\">\n      <span class=\"graph-annotation__title\">${annoTitle}</span>\n    <span class=\"graph-annotation__time\">${annoTime}</span></div>\n    <div class=\"graph-annotation__body\">\n      <div>${annoText}</div>\n      ${_.join(_.map(annoTags, t => `<span class=\"label label-tag small\" style=\"background-color: ${t.backColor}; border-color: ${t.borderColor}\">${t.text}</span>`), \"\")}\n    </div>\n      <div class=\"statusmap-histogram\"></div>`;\n\n    this.tooltip.html(tooltipHtml);\n\n    this.move(pos);\n  }\n\n  move(pos) {\n    if (!this.tooltipBase) { return; }\n\n    let elem = $(this.tooltipBase.node())[0];\n    let tooltipWidth = elem.clientWidth;\n    let tooltipHeight = elem.clientHeight;\n\n    let left = pos.pageX - tooltipWidth/2;\n    let top = pos.pageY + TOOLTIP_PADDING_Y;\n\n    if (pos.pageX + tooltipWidth/2 + 10 > window.innerWidth) {\n      left = pos.pageX - tooltipWidth - TOOLTIP_PADDING_X;\n    }\n\n    if (pos.pageY - window.pageYOffset + tooltipHeight + 20 > window.innerHeight) {\n      top = pos.pageY - tooltipHeight - TOOLTIP_PADDING_Y;\n    }\n\n    return this.tooltipBase\n      .style(\"left\", left + \"px\")\n      .style(\"top\", top + \"px\");\n  }\n}\n"],"file":"annotations.js"}
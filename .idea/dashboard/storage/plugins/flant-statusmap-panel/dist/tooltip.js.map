{"version":3,"sources":["../src/tooltip.ts"],"names":["d3","$","_","TOOLTIP_PADDING_X","TOOLTIP_PADDING_Y","StatusmapTooltip","elem","scope","dashboard","ctrl","panelCtrl","panel","heatmapPanel","mouseOverBucket","originalFillColor","on","onMouseOver","bind","onMouseLeave","e","tooltip","show","data","isEmpty","add","move","destroy","select","append","attr","remove","pos","panelRelY","cardId","target","card","cardsData","cards","x","y","value","values","tooltipTimeFormat","time","formatDate","tooltipHtml","color","mode","statuses","discreteHelper","convertValuesToTooltips","statusesHtml","length","join","map","v","useMax","multipleValues","dataWarnings","title","noColorDefined","badValues","getNotColoredValues","html","node","tooltipWidth","clientWidth","tooltipHeight","clientHeight","left","pageX","top","pageY","window","innerWidth","pageYOffset","innerHeight","style"],"mappings":"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","sourcesContent":["import d3 from 'd3';\nimport $ from 'jquery';\nimport _ from 'lodash';\n\nlet TOOLTIP_PADDING_X = 30;\nlet TOOLTIP_PADDING_Y = 5;\n\nexport class StatusmapTooltip {\n  tooltip: any;\n  scope: any;\n  dashboard: any;\n  panelCtrl: any;\n  panel: any;\n  heatmapPanel: any;\n  mouseOverBucket: any;\n  originalFillColor: any;\n\n  constructor(elem: any, scope: any) {\n    this.scope = scope;\n    this.dashboard = scope.ctrl.dashboard;\n    this.panelCtrl = scope.ctrl;\n    this.panel = scope.ctrl.panel;\n    this.heatmapPanel = elem;\n    this.mouseOverBucket = false;\n    this.originalFillColor = null;\n\n    elem.on(\"mouseover\", this.onMouseOver.bind(this));\n    elem.on(\"mouseleave\", this.onMouseLeave.bind(this));\n  }\n\n  onMouseOver(e) {\n    if (!this.panel.tooltip.show || !this.scope.ctrl.data || _.isEmpty(this.scope.ctrl.data)) { return; }\n\n    if (!this.tooltip) {\n      this.add();\n      this.move(e);\n    }\n  }\n\n  onMouseLeave() {\n    this.destroy();\n  }\n\n  onMouseMove(e) {\n    if (!this.panel.tooltip.show) { return; }\n\n    this.move(e);\n  }\n\n  add() {\n    this.tooltip = d3.select(\"body\")\n      .append(\"div\")\n      .attr(\"class\", \"statusmap-tooltip graph-tooltip grafana-tooltip\");\n  }\n\n  destroy() {\n    if (this.tooltip) {\n      this.tooltip.remove();\n    }\n\n    this.tooltip = null;\n  }\n\n  show(pos) {\n    if (!this.panel.tooltip.show || !this.tooltip) { return; }\n    // shared tooltip mode\n    if (pos.panelRelY) {\n      return;\n    }\n    let cardId = d3.select(pos.target).attr('cardId');\n    if (!cardId) {\n      this.destroy();\n      return;\n    }\n\n    let card = this.panelCtrl.cardsData.cards[cardId];\n    if (!card) {\n      this.destroy();\n      return;\n    }\n\n    let x = card.x;\n    let y = card.y;\n    let value = card.value;\n    let values = card.values;\n    let tooltipTimeFormat = 'YYYY-MM-DD HH:mm:ss';\n    let time = this.dashboard.formatDate(+x, tooltipTimeFormat);\n\n    let tooltipHtml = `<div class=\"graph-tooltip-time\">${time}</div>\n      <div class=\"statusmap-histogram\"></div>`;\n\n    if (this.panel.color.mode === 'discrete') {\n      let statuses = this.panelCtrl.discreteHelper.convertValuesToTooltips(values);\n      let statusesHtml = '';\n      if (statuses.length === 1) {\n        statusesHtml = \"status:\";\n      } else if (statuses.length > 1) {\n        statusesHtml = \"statuses:\";\n      }\n      tooltipHtml += `\n      <div>\n        name: <b>${y}</b> <br>\n        ${statusesHtml}\n        <ul>\n          ${_.join(_.map(statuses, v => `<li style=\"background-color: ${v.color}\" class=\"discrete-item\">${v.tooltip}</li>`), \"\")}\n        </ul>\n      </div>`;\n    } else {\n      if (values.length === 1) {\n        tooltipHtml += `<div> \n      name: <b>${y}</b> <br>\n      value: <b>${value}</b> <br>\n      </div>`;\n      } else {\n        tooltipHtml += `<div>\n      name: <b>${y}</b> <br>\n      values:\n      <ul>\n        ${_.join(_.map(values, v => `<li>${v}</li>`), \"\")}\n      </ul>\n      </div>`;\n      }\n    }\n\n    //   \"Ambiguous bucket state: Multiple values!\";\n    if (!this.panel.useMax && card.multipleValues) {\n      tooltipHtml += `<div><b>Error:</b> ${this.panelCtrl.dataWarnings.multipleValues.title}</div>`;\n    }\n\n    // Discrete mode errors\n    if (this.panel.color.mode === 'discrete') {\n      if (card.noColorDefined) {\n        let badValues = this.panelCtrl.discreteHelper.getNotColoredValues(values);\n        tooltipHtml += `<div><b>Error:</b> ${this.panelCtrl.dataWarnings.noColorDefined.title}\n        <br>not colored values:\n        <ul>\n          ${_.join(_.map(badValues, v => `<li>${v}</li>`), \"\")}\n        </ul>\n        </div>`;\n\n      }\n    }\n\n    this.tooltip.html(tooltipHtml);\n\n    this.move(pos);\n  }\n\n  move(pos) {\n    if (!this.tooltip) { return; }\n\n    let elem = $(this.tooltip.node())[0];\n    let tooltipWidth = elem.clientWidth;\n    let tooltipHeight = elem.clientHeight;\n\n    let left = pos.pageX + TOOLTIP_PADDING_X;\n    let top = pos.pageY + TOOLTIP_PADDING_Y;\n\n    if (pos.pageX + tooltipWidth + 40 > window.innerWidth) {\n      left = pos.pageX - tooltipWidth - TOOLTIP_PADDING_X;\n    }\n\n    if (pos.pageY - window.pageYOffset + tooltipHeight + 20 > window.innerHeight) {\n      top = pos.pageY - tooltipHeight - TOOLTIP_PADDING_Y;\n    }\n\n    return this.tooltip\n      .style(\"left\", left + \"px\")\n      .style(\"top\", top + \"px\");\n  }\n}\n"],"file":"tooltip.js"}